# Grafana Alert Rules for Email Engine
# Import via Grafana UI or API

groups:
  - name: email-engine-alerts
    rules:
      # PowerMTA down
      - alert: PowerMTADown
        expr: email_engine_pmta_running == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PowerMTA is down"
          description: "PowerMTA has been down for 2+ minutes"

      # High bounce rate (bounces received vs forwarded as proxy)
      - alert: HighBounceRate
        expr: rate(email_engine_bounces_received_total[1h]) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High bounce volume"
          description: "Receiving {{ $value }} bounces/hour, investigate delivery issues"

      # IP blacklisted
      - alert: IPBlacklisted
        expr: email_engine_ips_blacklisted > 0
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "IP blacklisted"
          description: "{{ $value }} IP(s) currently blacklisted, check blacklist events"

      # Disk space
      - alert: DiskSpaceLow
        expr: email_engine_disk_usage_pct > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Disk usage > 85%"
          description: "Disk usage is at {{ $value }}%"

      # Queue size
      - alert: HighQueueSize
        expr: email_engine_pmta_queue_size > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PowerMTA queue > 10K"
          description: "Queue has {{ $value }} messages, check for delivery issues"

      # Service down (scrape target unreachable)
      - alert: EmailEngineDown
        expr: up{job="email-engine"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Email Engine API is unreachable"
          description: "Prometheus cannot scrape Email Engine metrics for 2+ minutes"
