################################################################################
# EMAIL-ENGINE V2 — CONFIGURATION PRODUCTION (Multi-PowerMTA jusqu'à 5 VPS)
#
# Architecture complète :
#   VPS1 (Hetzner)  : MailWizz + Email-Engine API (Docker) + PostgreSQL
#                     → sos-holidays.com (domaine d'administration MailWizz)
#   VPS2 (Contabo)  : PowerMTA — hub-travelers.com + emilia-mullerd.com ← ACTIF
#   VPS3 (Contabo)  : PowerMTA — plane-liberty.com + planevilain.com    ← ACTIF
#   VPS4 (Contabo)  : PowerMTA — domaines futurs (ajouter via console admin)
#   VPS5 (Contabo)  : PowerMTA — domaines futurs (ajouter via console admin)
#   VPS6 (Contabo)  : PowerMTA — domaines futurs (ajouter via console admin)
#
# Principe : 1 domaine racine = 1 IP dédiée = 1 sous-domaine mail.DOMAIN
#   hub-travelers.com  → IP_VPS2_1 → mail.hub-travelers.com → vmta-hub-travelers
#   emilia-mullerd.com → IP_VPS2_2 → mail.emilia-mullerd.com → vmta-emilia-mullerd
#   plane-liberty.com  → IP_VPS3_1 → mail.plane-liberty.com → vmta-plane-liberty
#   planevilain.com    → IP_VPS3_2 → mail.planevilain.com   → vmta-planevilain
#
# Ajout de nouveaux VPS PowerMTA → console admin :
#   1. Déployer install.sh sur le nouveau VPS Contabo
#   2. Renseigner PMTA_VPS4_HOST et PMTA_VPS4_DOMAINS dans .env
#   3. Redémarrer l'API (docker compose up -d)
#   4. POST /api/v1/ips pour chaque domaine/IP du nouveau VPS
#
# PowerMTA géré par SSH interne — aucune API HTTP exposée (port 1983 fermé).
# MailWizz géré par MySQL direct — aucune API REST utilisée.
################################################################################

# ═══════════════════════════════════════════════════════════
# API
# ═══════════════════════════════════════════════════════════
API_KEY=générer_une_clé_forte_min_32_caractères
JWT_SECRET_KEY=générer_un_secret_jwt_fort_min_32_caractères
ENVIRONMENT=production
LOG_LEVEL=info

# ═══════════════════════════════════════════════════════════
# Base de données PostgreSQL (container Docker sur VPS1)
# ═══════════════════════════════════════════════════════════
DATABASE_URL=postgresql://email_engine:MOT_DE_PASSE_FORT@postgres:5432/email_engine_v2
POSTGRES_DB=email_engine_v2
POSTGRES_USER=email_engine
POSTGRES_PASSWORD=MOT_DE_PASSE_FORT_POSTGRES

# ═══════════════════════════════════════════════════════════
# Redis (container Docker sur VPS1)
# ═══════════════════════════════════════════════════════════
REDIS_URL=redis://redis:6379/0

# ═══════════════════════════════════════════════════════════
# MailWizz — MySQL direct (VPS1 hôte — sur la même machine)
#
# IMPORTANT : On n'utilise PAS l'API REST MailWizz — MySQL direct uniquement.
# Le container Docker accède à MySQL via host.docker.internal (VPS1 hôte).
# ═══════════════════════════════════════════════════════════
MAILWIZZ_DB_HOST=host.docker.internal   # MySQL MailWizz sur l'hôte VPS1
MAILWIZZ_DB_PORT=3306
MAILWIZZ_DB_USER=mailwizz
MAILWIZZ_DB_PASSWORD=mot_de_passe_mysql_mailwizz_fort
MAILWIZZ_DB_NAME=mailwizz_v2

# Paramètres des delivery servers (créés automatiquement via POST /api/v1/ips)
MAILWIZZ_FROM_NAME=Hub Travelers          # Nom expéditeur par défaut
MAILWIZZ_DS_MAX_CONN_MESSAGES=50          # Messages max par connexion SMTP
MAILWIZZ_DS_HOURLY_QUOTA=5               # Quota horaire initial (warmup day 1)
# NOTE : Le quota évolue automatiquement chaque jour via le warmup engine.

# ═══════════════════════════════════════════════════════════
# PowerMTA — Multi-nœuds (VPS2 + VPS3 + VPS4 optionnel)
#
# L'API gère PowerMTA à distance via SSH :
#   - POST /api/v1/ips     → ajoute virtual-mta + pattern-list sur le bon nœud
#   - DELETE /api/v1/ips/N → supprime vmta + pattern-list + delivery server
#   - Routing automatique  → hostname → domaine → nœud (vps2|vps3|vps4)
#
# Clé SSH : ./secrets/pmta_ssh_key (générée une fois, copiée sur chaque VPS)
#   ssh-keygen -t ed25519 -f secrets/pmta_ssh_key -N ""
#   ssh-copy-id -i secrets/pmta_ssh_key.pub root@VPS2_IP
#   ssh-copy-id -i secrets/pmta_ssh_key.pub root@VPS3_IP
# ═══════════════════════════════════════════════════════════
PMTA_SSH_USER=root
PMTA_SSH_KEY_PATH=/app/secrets/pmta_ssh_key   # Monté via volume Docker
PMTA_SMTP_PORT=2525                            # Port SMTP PowerMTA (relay interne)

# ── VPS2 (Contabo) ──────────────────────────────────────────
# Domaines : hub-travelers.com + emilia-mullerd.com
PMTA_VPS2_HOST=IP_CONTABO_VPS2                 # ex: 85.215.x.x
PMTA_VPS2_DOMAINS=hub-travelers.com,emilia-mullerd.com

# ── VPS3 (Contabo) ──────────────────────────────────────────
# Domaines : plane-liberty.com + planevilain.com
PMTA_VPS3_HOST=IP_CONTABO_VPS3                 # ex: 85.215.x.x
PMTA_VPS3_DOMAINS=plane-liberty.com,planevilain.com

# ── VPS4 (Contabo) — Domaines futurs (activer via console admin) ────────────
PMTA_VPS4_HOST=                                # Laisser vide jusqu'à déploiement
PMTA_VPS4_DOMAINS=                             # ex: domain5.com,domain6.com

# ── VPS5 (Contabo) — Domaines futurs ────────────────────────────────────────
PMTA_VPS5_HOST=
PMTA_VPS5_DOMAINS=

# ── VPS6 (Contabo) — Domaines futurs (5ème PowerMTA) ────────────────────────
PMTA_VPS6_HOST=
PMTA_VPS6_DOMAINS=

# ═══════════════════════════════════════════════════════════
# Warmup — Ultra-protecteur (70 jours, 10 semaines)
#
# Progression quotidienne ultra-lente pour éviter tout blacklist.
# Les quotas ci-dessous remplacent le tableau DAILY_QUOTAS du code
# si tu veux personnaliser (sinon les valeurs par défaut s'appliquent).
#
# Semaine 1 :  5 → 20 emails/jour   (rodage ISP, réputation zéro)
# Semaine 2 : 25 → 50 emails/jour   (confirmation délivrabilité)
# Semaine 3 : 60 → 120 emails/jour  (montée progressive)
# Semaine 4 : 150 → 300 emails/jour
# Semaine 5 : 400 → 800 emails/jour
# Semaine 6 : 1000 → 2000 emails/jour
# Semaine 7 : 2500 → 5000 emails/jour
# Semaine 8 : 6000 → 10000 emails/jour
# Semaine 9 : 12000 → 16000 emails/jour
# Semaine 10: 18000 → 20000 emails/jour (vitesse de croisière)
# ═══════════════════════════════════════════════════════════
WARMUP_ENABLED=true

# Seuils de sécurité — palier 7 jours glissants (pause temporaire)
WARMUP_MAX_BOUNCE_RATE=2.0      # 2% bounce → pause 72h
WARMUP_MAX_SPAM_RATE=0.03       # 0.03% spam → pause 96h

# Seuils d'urgence — 24h (quarantaine 30 jours)
WARMUP_EMERGENCY_BOUNCE_RATE=5.0   # 5% bounce/24h → quarantaine
WARMUP_EMERGENCY_SPAM_RATE=0.1     # 0.1% spam/24h → quarantaine

# Durées des pauses (en heures — config.py)
WARMUP_PAUSE_BOUNCE_HOURS=72    # Pause bounce = 3 jours (72h)
WARMUP_PAUSE_SPAM_HOURS=96      # Pause spam = 4 jours (96h)

# ═══════════════════════════════════════════════════════════
# Rotation des IPs
# ═══════════════════════════════════════════════════════════
IP_QUARANTINE_DAYS=30
IP_REST_DAYS=7

# ═══════════════════════════════════════════════════════════
# Blacklist
# ═══════════════════════════════════════════════════════════
BLACKLIST_CHECK_INTERVAL_HOURS=4

# ═══════════════════════════════════════════════════════════
# Alertes Telegram (recommandé — alertes temps réel)
# Créer un bot : @BotFather sur Telegram → /newbot
# ═══════════════════════════════════════════════════════════
TELEGRAM_BOT_TOKEN=ton_token_bot_telegram
TELEGRAM_CHAT_ID=ton_chat_id_telegram

# ═══════════════════════════════════════════════════════════
# Monitoring Grafana
# ═══════════════════════════════════════════════════════════
GRAFANA_USER=admin
GRAFANA_PASSWORD=mot_de_passe_grafana_fort

# ═══════════════════════════════════════════════════════════
# VPS1 (Hetzner) — Configuration MailWizz installé sur l'hôte
# Ces variables sont utilisées par deploy/vps1-mailwizz/install.sh
# ═══════════════════════════════════════════════════════════
VPS1_IP=IP_HETZNER_VPS1                        # IP public du VPS1 Hetzner

# ═══════════════════════════════════════════════════════════
# INSTALLATION VPS2/VPS3 — Variables pour install.sh
# Ces variables sont utilisées par deploy/vps2-pmta/install.sh
# et deploy/vps3-pmta/install.sh lors de l'installation initiale.
# ═══════════════════════════════════════════════════════════

# VPS2
DOMAIN1=hub-travelers.com
DOMAIN2=emilia-mullerd.com
IP1=IP_CONTABO_VPS2_PRINCIPALE    # IP incluse avec le VPS2
IP2=IP_CONTABO_VPS2_ADDITIONNELLE # IP additionnelle commandée (~1€/mois)

# VPS3
# (redéfinir DOMAIN1/DOMAIN2/IP1/IP2 lors de l'installation de VPS3)
# DOMAIN1=plane-liberty.com
# DOMAIN2=planevilain.com
# IP1=IP_CONTABO_VPS3_PRINCIPALE
# IP2=IP_CONTABO_VPS3_ADDITIONNELLE

# ═══════════════════════════════════════════════════════════
# NOTES DE SÉCURITÉ
# ═══════════════════════════════════════════════════════════
# 1. JAMAIS commit .env.production dans git — vérifier .gitignore
# 2. Mots de passe > 32 caractères (générateur : openssl rand -base64 32)
# 3. Clé SSH PowerMTA : ./secrets/pmta_ssh_key (chmod 600, JAMAIS dans git)
# 4. PostgreSQL exposé uniquement sur 127.0.0.1 (pas en public)
#
# Firewall VPS1 (Hetzner — MailWizz + Email-Engine API) :
#   - 80, 443  → public (MailWizz frontend)
#   - 8000     → privé ou derrière nginx (Email-Engine API)
#   - 22       → SSH admin uniquement
#   - 3306     → JAMAIS exposé (MySQL local only)
#
# Firewall VPS2/VPS3/VPS4 (Contabo — PowerMTA) :
#   - 25       → public (SMTP sortant vers les ESPs)
#   - 2525     → UNIQUEMENT depuis IP de VPS1 (relay interne)
#               ufw allow from VPS1_IP to any port 2525 proto tcp
#               ufw deny 2525/tcp
#   - 1983     → localhost uniquement (management PowerMTA — jamais exposé)
#   - 22       → SSH admin uniquement
#
# Email postmaster (1 seule vraie boîte pour tous les domaines) :
#   - Créer : admin@hub-travelers.com (Zoho/Gmail)
#   - Cloudflare Email Routing pour les autres domaines :
#     admin@emilia-mullerd.com  → admin@hub-travelers.com
#     admin@plane-liberty.com  → admin@hub-travelers.com
#     admin@planevilain.com    → admin@hub-travelers.com
